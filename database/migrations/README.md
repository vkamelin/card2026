# Миграции для модуля "Колесо удачи"

## Список созданных миграций

### 1. `20251124155645_alter_wheel_prizes_add_new_types.php`
**Описание**: Модификация таблицы `wheel_prizes` для добавления новых типов призов ('none', 'custom')

**Изменения**:
- Расширение ENUM поля `type` для добавления значений 'none' и 'custom'
- Добавление комментария к таблице

### 2. `20251124155722_create_wheel_custom_prizes_table.php`
**Описание**: Создание таблицы `wheel_custom_prizes` для хранения кастомных призов

**Структура таблицы**:
- `id` - первичный ключ
- `wheel_prize_id` - внешний ключ к таблице `wheel_prizes`
- `title` - заголовок кастомного приза
- `description` - описание кастомного приза
- `image_url` - URL изображения приза
- `action_type` - тип действия при активации (link, message, callback)
- `action_data` - данные для действия
- `is_active` - флаг активности
- `created_at`, `updated_at` - временные метки

**Индексы**:
- `idx_wheel_custom_prizes_active` - для фильтрации по активности
- `idx_wheel_custom_prizes_prize_id` - для поиска по связанному призу

### 3. `20251124155846_alter_wheel_spins_add_tracking_fields.php`
**Описание**: Модификация таблицы `wheel_spins` для добавления полей отслеживания выигрышных спинов

**Изменения**:
- Добавление поля `is_winning` - флаг выигрышного спина
- Добавление поля `custom_prize_id` - внешний ключ к кастомному призу
- Добавление поля `ip_address` - IP адрес пользователя
- Добавление поля `user_agent` - User Agent браузера
- Добавление внешнего ключа к таблице `wheel_custom_prizes`
- Добавление комментария к таблице

**Индексы**:
- `idx_wheel_spins_winning` - для фильтрации по выигрышным спинам
- `idx_wheel_spins_custom_prize_id` - для поиска по кастомному призу
- `idx_wheel_spins_ip` - для поиска по IP адресу
- `idx_wheel_spins_date_user` - для поиска по пользователю и дате

### 4. `20251124155926_create_wheel_daily_limits_table.php`
**Описание**: Создание таблицы `wheel_daily_limits` для отслеживания дневных лимитов

**Структура таблицы**:
- `id` - первичный ключ
- `date` - дата
- `total_spins` - общее количество спинов за день
- `winning_spins` - количество выигрышных спинов за день
- `created_at`, `updated_at` - временные метки

**Индексы**:
- `uk_wheel_daily_limits_date` - уникальный индекс по дате
- `idx_wheel_daily_limits_date` - для поиска по дате

### 5. `20251124155950_add_wheel_settings_updates.php`
**Описание**: Добавление новых настроек в таблицу `wheel_settings`

**Добавленные настройки**:
- `daily_spin_limit` - максимальное количество спинов в день
- `enable_custom_prizes` - включены ли кастомные призы
- `track_user_ip` - отслеживать IP адреса пользователей
- `min_probability_threshold` - минимальный порог вероятности для призов
- `enable_daily_limits` - включено ли ограничение по дневным лимитам
- `custom_prize_ttl` - время жизни кастомных призов в днях

## Откат изменений (down-методы)

Каждая миграция содержит корректно реализованный метод `down()`, который откатывает все изменения, сделанные в методе `up()`:

1. Для миграций создания таблиц - удаляется созданная таблица
2. Для миграций модификации таблиц - возвращаются предыдущие значения полей
3. Для миграций добавления данных - удаляются добавленные записи

## Рекомендации по использованию Redis

Для оптимизации производительности рекомендуется использовать Redis для кэширования:

1. **Кэширование призов**: Хранить список активных призов с TTL 30 минут
   ```php
   // Ключ: wheel:prizes:active
   // TTL: 1800 секунд (30 минут)
   ```

2. **Кэширование дневных лимитов**: Хранить статистику по дневным лимитам с TTL 5 минут
   ```php
   // Ключ: wheel:daily_limits:{date}
   // TTL: 300 секунд (5 минут)
   ```

3. **Кэширование настроек**: Хранить настройки модуля с TTL 60 минут
   ```php
   // Ключ: wheel:settings
   // TTL: 3600 секунд (60 минут)
   ```

## Индексы для оптимизации запросов

Все созданные таблицы содержат необходимые индексы для оптимизации часто используемых запросов:
- Поиск по пользователю и дате
- Фильтрация по активности
- Поиск по дате
- Поиск по внешним ключам